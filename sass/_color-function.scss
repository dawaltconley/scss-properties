@use 'sass:color';
@use 'sass:list';
@use 'sass:map';
@use 'sass:math';
@use 'sass:meta';
@use 'var';
@use 'args';
@use 'utils';
@use 'color' as clr;

@function _getColorType($function, $colors, $args...) {
  $colorType: args.parseKwargs($args...);
  @if not $colorType {
    @if $function == var.$SCALE {
      $colorType: var.$HSL;
    } @else if $function == var.$MIX {
      $colorType: var.$RGB;
    } @else {
      $colorType: args.parsePositional($args...) or var.$HSL;
    }
  }
  @if list.length($colorType) == 3 and clr.hasAlpha($colors...) or args.hasAlpha($args...) {
    $colorType: list.append($colorType, var.$ALPHA);
  }
  @return $colorType;
}

@function _calcProperties($function, $colorName, $args...) {
  $kwargs: meta.keywords($args);
  $ops: ();
  @each $property, $value in $kwargs {
    @if $value {
      $newOp: null;
      @if $function == var.$MIX {
        $newOp: utils.calcMix($colorName, $value..., $colorProp: $property);
      } @else {
        $newOp: utils.calcProperty($value, $colorName, $property, $function);
      }
      $ops: map.set($ops, $property, $newOp);
    }
  }
  @return $ops;
}

@function _calcColor($function, $colorName, $args...) {
  $colorType: _getColorType($function, $colorName, $args...);
  $kwargs: args.normalize($colorType, $args...);
  $properties: _calcProperties($function, $colorName, $kwargs...);
  $defaults: clr.defaults($colorName, $colorType);
  $properties: map.merge($defaults, $properties);
  @return clr.makeColor($properties...);
}

@function adjust($colorName, $args...) {
  @return _calcColor(var.$ADJUST, $colorName, $args...);
}

@function change($colorName, $args...) {
  @return _calcColor(var.$CHANGE, $colorName, $args...);
};

@function scale($colorName, $args...) {
  @return _calcColor(var.$SCALE, $colorName, $args...);
};

@function mix($colorName1, $colorName2, $weight: 50%, $args...) {
  $colorType: _getColorType(var.$MIX, ($colorName1 $colorName2), $weight: $weight, $args...);
  $kwargs: args.normalize($colorType, $args...);
  $ops: ();
  @each $property in $colorType {
    $w: map.get($kwargs, $property) or $weight;
    $ops: map.set($ops, $property, utils.calcMix($colorName1, $colorName2, $w, $property));
  }
  @return clr.makeColor($ops...);
}

@function _parseSetArg($arg) {
  $function: list.index(var.$FUNCTIONS, $arg) and $arg;
  $property: map.has-key(var.$PROPERTIES, $arg) and $arg;
  @if not $function and not $property {
    @error 'Bad argument for set function: #{$arg}';
  }
  @return $function, $property;
}

// could simplify if I changed the previous function outputs and used meta.call
@function _getOperation($colorName, $property: null, $type: null, $settings: null) {
  @if not $property {
    @error 'Must specify color property: #{$property} #{$type} #{$settings}';
  }
  @if not $type {
    @error 'Must specify modification type: #{$property} #{$type} #{$settings}';
  }
  @if $type == 'mix' {
    $colorName2: list.nth($settings, 1); // allow map as well
    $weight: list.nth($settings, 2) or 50%;
    $invert: $property == var.$HUE and _invertHue($colorName, $colorName2);
    // invert option
    @return utils.calcMix($colorName, $colorName2, $weight, $property, $modify: $invert and -360deg);
  } @else {
    $param: list.nth($settings, 1);
    @return utils.calcProperty($param, $colorName, $property, $type);
  }
}

@function set($colorName, $argList...) {
  $setMap: meta.keywords($argList);

  $ops: ();
  $args: ();
  @each $key1, $value in $setMap {
    $arg1: _parseSetArg($key1);
    @if meta.type-of($value) == 'list' and meta.type-of(list.nth($value, 1) != 'list') {
      $settings: ();
      @for $i from 2 through list.length($value) {
        $settings: list.append($settings, list.nth($value, $i));
      }
      $value: (#{list.nth($value, 1)}: $settings);
    }
    @each $key2, $settings in $value {
      $arg2: _parseSetArg($key2);
      $function: list.nth($arg1, 1) or list.nth($arg2, 1);
      $property: list.nth($arg1, 2) or list.nth($arg2, 2);
      @if list.length($settings) == 1 {
        $settings: list.nth($settings, 1);
      }
      $ops: map.set($ops, $function, $property, $settings);
      $args: map.set($args, $property, $settings);
    }
  }

  $colorType: args.parseKwargs($args...);
  $colorProps: clr.defaults($colorName, $colorType);

  @each $function, $propValues in $ops {
    $newProps: _calcProperties($function, $colorName, $propValues...);
    $colorProps: map.merge($colorProps, $newProps);
  }

  @return clr.makeColor($colorProps...);
}

@mixin define($colorMap, $parent: '', $forceAlpha: true) {
  @if (meta.type-of($colorMap) == 'map') {
    @each $colorName in map.keys($colorMap) {
      $name: #{$parent}#{$colorName};
  
      @if ($colorName == 'color') {
        $name: #{$parent};
      }
  
      $color: map.get($colorMap, $colorName);
  
      $isColor: meta.type-of($color) == 'color';
      $isMap: meta.type-of($color) == 'map';
      $priorAlpha: clr.hasAlpha($colorName);
      $isAlpha: $forceAlpha or $priorAlpha or ($isColor and color.alpha($color) != 1);
  
      @if ($isMap) {
        @include define($color, $parent: $name);
      } @else if ($isColor) {
        $name-r: #{$name}#{var.$POSTFIX-RED};
        $name-g: #{$name}#{var.$POSTFIX-GREEN};
        $name-b: #{$name}#{var.$POSTFIX-BLUE};
        $name-h: #{$name}#{var.$POSTFIX-HUE};
        $name-s: #{$name}#{var.$POSTFIX-SATURATION};
        $name-l: #{$name}#{var.$POSTFIX-LIGHTNESS};
        $name-a: #{$name}#{var.$POSTFIX-ALPHA};
  
        $type: if($isAlpha, var.$HSLA, var.$HSL);
        $defaults: clr.defaults($name, $type);
  
        #{$name}: clr.makeColor($defaults...);
        #{$name-r}: color.red($color);
        #{$name-g}: color.green($color);
        #{$name-b}: color.blue($color);
        #{$name-h}: color.hue($color);
        #{$name-s}: color.saturation($color);
        #{$name-l}: color.lightness($color);
        @if ($isAlpha) {
          #{$name-a}: color.alpha($color);
        }

        var.$COLORS: map.set(var.$COLORS, $name, (
          'color': $color,
          'alpha': $isAlpha,
        ));
      } @else {
        #{$name}: $color;
      }
    }
  }
}
